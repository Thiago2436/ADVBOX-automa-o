Vis√£o Geral da Solu√ß√£o
 O objetivo √© automatizar um fluxo ‚Äúe-mail ‚Üí tarefa‚Äù para que, quando um cliente envie um pedido contratual √† caixa compartilhada do Outlook 365, o sistema:
Capte o e-mail via Power Automate (Fluxo na Nuvem).


Verifique se o remetente/cliente est√° autorizado (ativo, inativo ou n√£o cadastrado) consultando a API de consulta de clientes do ADVBox (ou uma lista interna).


Envie o conte√∫do do e-mail a um LLM (Azure OpenAI) que:


Classifique o tipo de solicita√ß√£o (novo contrato, renova√ß√£o, altera√ß√£o, rescis√£o, etc.).


Extraia dados estruturados (nome do cliente, n√∫mero do contrato, valor, prazo, advogado respons√°vel, etc.).


Gere um resumo sucinto em portugu√™s.


Crie a tarefa no ADVBox usando RPA (Browser-Use) para preencher o formul√°rio web, pois n√£o h√° endpoint POST dispon√≠vel.


Envie e-mail de confirma√ß√£o ao cliente e copie ao advogado respons√°vel, informando o n√∫mero da tarefa e o resumo.


Como o ADVBox n√£o possui endpoints para criar tarefas, a automa√ß√£o de ‚Äúcriar tarefa‚Äù ser√° implementada com Power Automate Desktop (ou Power Automate UI Flow) para simular a navega√ß√£o e o preenchimento na interface web. Todo o restante roda em Azure (Power Automate Cloud, Azure Functions, Azure OpenAI e Azure Key Vault) e no Power Automate Desktop como RPA.

1. Pr√©-requisitos
Azure Subscription (com recurso para:


Azure Functions (para hospedar nossas fun√ß√µes ‚ÄúValidaCliente‚Äù e ‚ÄúProcessaEmail‚Äù).


Azure OpenAI (para usar o LLM).


Azure Key Vault (para guardar segredos: chaves do OpenAI, credenciais de login no ADVBox, token de consulta de clientes).


Azure Storage Account (opcional, caso queiramos guardar anexos do e-mail temporariamente).


Power Automate Cloud (licen√ßa que permita:


Conectores Office 365 Outlook (para ler e-mails da caixa compartilhada).


Conector ‚ÄúExecutar fluxo de Desktop‚Äù para disparar o RPA.


Power Automate Desktop (para criar o RPA que preenche o ADVBox).


Caixa de E-mail Compartilhada no Outlook 365 (ex.: suporte@seudominio.com), com permiss√£o de ‚ÄúLer todas as mensagens‚Äù para o conector do Power Automate.


Credenciais de um usu√°rio ADVBox (com permiss√£o de criar tarefas pela interface web). Se poss√≠vel, crie um usu√°rio espec√≠fico para automa√ß√£o (evitando 2FA).


Token de Acesso (Bearer) para consultar dados de cliente via API GET do ADVBox (caso voc√™ v√° validar ‚Äúativo/inativo‚Äù desse modo).


Volume estimado: at√© 30 chamados/dia, anexos de at√© 10 MB cada.


Equipes:


Interna de TI (para aprovar as configura√ß√µes e testes).


Interna de Suporte Jur√≠dico (para receber e-mails de confirma√ß√£o e acompanhar tickets).



2. Arquitetura de Alto N√≠vel
+------------------+      ‚ë† e-mail chega      +------------------------+
| Cliente / Advogado| --------------------->  | Caixa Compartilhada    |
+------------------+                          |   Outlook 365          |
                                              +------------------------+
                                                     ‚îÇ
                                                     ‚îÇ (Power Automate Cloud ‚ÄúQuando um e-mail chega‚Äù)
                                                     ‚ñº
                     +---------------------------------------------------+
                     |           Power Automate (Fluxo na Nuvem)         |
                     |                                                   |
                     | 1. (Opcional) Verifica dom√≠nio do remetente       |
                     | 2. Chama Azure Function ‚ÄúValidaCliente‚Äù (HTTP)    |
                     |    ‚Üí retorna status: ‚Äúativo‚Äù, ‚Äúinativo‚Äù ou ‚Äún√£o encontrado‚Äù |
                     | 3. Se ‚Äúinativo‚Äù ou ‚Äún√£o encontrado‚Äù ‚Üí envia e-mail de aviso e encerra |
                     |    Se ‚Äúativo‚Äù ‚Üí seguiu              			  |
                     | 4. (Opcional) Obter anexos do e-mail, enviar ao  |
                     |    Blob Storage e montar array de URLs SAS        |
                     | 5. Chama Azure Function ‚ÄúProcessaEmail‚Äù (HTTP)    |
                     |    ‚Üí LLM (Azure OpenAI) retorna JSON com:         |
                     |      ‚Ä¢ cliente                                       |
                     |      ‚Ä¢ tipoSolicitacao                               |
                     |      ‚Ä¢ dadosExtraidos (numeroContrato, valor, prazo, advogadoResponsavel) |
                     |      ‚Ä¢ summary                                      |
                     |      ‚Ä¢ anexosParaRPA (lista de {filename, blobUrl})|
                     | 6. Se JSON OK e statusCliente == ‚Äúativo‚Äù ‚Üí chama   |
                     |    RPA (Power Automate Desktop) para criar tarefa  |
                     |    no ADVBox (recebendo vari√°veis: cliente, tipo,..., anexos) |
                     |    e retorna ‚ÄúidAdvBox‚Äù                            |
                     | 7. Envia e-mail de confirma√ß√£o ao cliente + advogado|
                     +---------------------------------------------------+

Azure Function ‚ÄúValidaCliente‚Äù (HTTP Trigger)
 ‚Äì Recebe nome ou e-mail do cliente e faz GET na API ADVBox (/clientes?filter=name eq '<cliente>') usando token.
 ‚Äì Retorna { "status": "ativo" }, { "status": "inativo" } ou { "status": "nao_encontrado" }.


Azure Function ‚ÄúProcessaEmail‚Äù (HTTP Trigger)
 ‚Äì Recebe JSON com remetente, assunto, corpo, URLs SAS dos anexos.
 ‚Äì Monta prompt para LLM (Azure OpenAI), pedindo:


Classificar tipo de solicita√ß√£o (ex.: ‚Äúnovo_contrato‚Äù, ‚Äúrenovacao_contrato‚Äù, ‚Äúalteracao_contrato‚Äù, ‚Äúrescisao_contrato‚Äù, ‚Äúoutro‚Äù).


Extrair campos: cliente, numeroContrato, valor, prazo, advogadoResponsavel.


Gerar resumo em at√© 3 frases.
 ‚Äì Chama Azure OpenAI (GPT-3.5-turbo ou GPT-4) e recebe resposta apenas em JSON.
 ‚Äì Constr√≥i retorno final, incluindo a lista anexosParaRPA (cada item: { "filename": "...", "blobUrl": "https://...SAS..." }).


Power Automate Desktop (RPA)
 ‚Äì Executa em uma m√°quina Windows (ou VM Windows) que esteja sempre ligada.
 ‚Äì Par√¢metros de entrada do fluxo:
 ‚Ä¢ cliente (string)
 ‚Ä¢ tipoSolicitacao (string)
 ‚Ä¢ numeroContrato (string)
 ‚Ä¢ valor (string)
 ‚Ä¢ prazo (string)
 ‚Ä¢ advogadoResponsavel (string)
 ‚Ä¢ summary (string)
 ‚Ä¢ anexosParaRPA (list com { filename, blobUrl }).
 ‚Äì Passos no RPA:


Abrir navegador (Chrome/Edge) em https://app.advbox.com/login.


Fazer login com credenciais armazenadas no PAD (‚ÄúGerenciar Credenciais‚Äù).


Navegar at√© ‚ÄúNova Tarefa‚Äù.


Preencher campos: t√≠tulo, descri√ß√£o, cliente, n√∫mero do contrato, valor, prazo, advogado.


Para cada item em anexosParaRPA:
 a. Abrir blobUrl para baixar o anexo em %Downloads%.
 b. Aguardar download completo.
 c. No formul√°rio ADVBox, clicar em ‚ÄúAnexar arquivo‚Äù e apontar para %Downloads%\{filename}.
 d. (Opcional) Excluir o arquivo local.


Clicar em ‚ÄúSalvar‚Äù.


Extrair n√∫mero da tarefa (ex.: Regex em ‚ÄúTarefa #1234 criada com sucesso‚Äù).


Retornar para o Power Automate Cloud: { "idAdvBox": "1234" }.


Power Automate Cloud
 ‚Äì Recebe ‚ÄúidAdvBox‚Äù do RPA e envia e-mail de confirma√ß√£o para:


‚ÄúPara‚Äù: remetente original (cliente).


‚ÄúCC‚Äù: advogadoResponsavel (e-mail retornado pelo LLM).
 ‚Äì Assunto: Confirma√ß√£o de Tarefa ADVBox ‚Äì #@{idAdvBox}
 ‚Äì Corpo (exemplo):

 Ol√° @{body('ResultadoEmail')?['cliente']},

Sua solicita√ß√£o foi processada com sucesso!
‚Üí N√∫mero da Tarefa ADVBox: @{body('saidaRPA')?['idAdvBox']}
‚Üí Resumo: @{body('ResultadoEmail')?['summary']}

Advogado respons√°vel (@{body('ResultadoEmail')?['dadosExtraidos/advogadoResponsavel']}) j√° foi copiado.

Atenciosamente,
Equipe de Automa√ß√£o



3. Detalhamento de Cada Componente
3.1. Azure Key Vault
Segredos a criar:


OPENAI_API_KEY ‚Üí chave do Azure OpenAI (obtida no portal Azure_OpenAI ‚Üí Keys & Endpoint).


ADVBOX_USER ‚Üí usu√°rio de login no ADVBox (para o RPA).


ADVBOX_PASS ‚Üí senha do usu√°rio RPA no ADVBox.


ADVBOX_API_TOKEN ‚Üí token OAuth2/Bearer para consultar dados de clientes (API GET).


(Opcional) BLOB_CONNECTION_STRING ‚Üí connection string do Storage Account, caso a Azure Function gere URLs SAS.


Permiss√µes:


Conceder √† Managed Identity do Function App permiss√£o ‚ÄúGet‚Äù para esses segredos.


(Opcional) Conceder √† Managed Identity do Function App ou a um Service Principal permiss√£o de gera√ß√£o de SAS no Storage.



3.2. Azure Function ‚ÄúValidaCliente‚Äù (opcional, mas recomendado)
Escopo: verificar se o ‚Äúcliente‚Äù extra√≠do do e-mail existe e est√° ativo no sistema ADVBox.
# Arquivo: valida_cliente_function.py
import os
import json
import logging
import azure.functions as func
import requests
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

KEYVAULT_NAME = os.getenv("KEYVAULT_NAME")  # ex.: "eluminai-kv"
KV_URI = f"https://{KEYVAULT_NAME}.vault.azure.net"
ADVBOX_API_BASE = "https://api.softwareadvbox.com.br/v1"  # Base da API

def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info("Iniciando ValidaCliente")

    try:
        body = req.get_json()
        cliente = body.get("cliente", "").strip()
        if not cliente:
            return func.HttpResponse("campo 'cliente' √© obrigat√≥rio.", status_code=400)
    except:
        return func.HttpResponse("JSON inv√°lido.", status_code=400)

    # Obter token do Key Vault
    credential = DefaultAzureCredential()
    secret_client = SecretClient(vault_url=KV_URI, credential=credential)
    advbox_token = secret_client.get_secret("ADVBOX_API_TOKEN").value

    # Fazer GET na API ADVBox
    url = f"{ADVBOX_API_BASE}/clientes?filter=name eq '{cliente}'"
    headers = {
        "Authorization": f"Bearer {advbox_token}",
        "Content-Type": "application/json"
    }
    resp = requests.get(url, headers=headers, timeout=10)
    if resp.status_code != 200:
        logging.error(f"Erro ao consultar ADVBox: {resp.status_code} ‚Äì {resp.text}")
        return func.HttpResponse("Erro no servi√ßo ADVBox.", status_code=500)

    dados = resp.json()
    if not dados.get("value"):
        status = "nao_encontrado"
    else:
        info = dados["value"][0]
        sts = info.get("status", "").lower()  # supondo ‚ÄúAtivo‚Äù ou ‚ÄúInativo‚Äù
        status = "ativo" if sts == "ativo" else "inativo"

    resultado = { "status": status }
    return func.HttpResponse(json.dumps(resultado), status_code=200, mimetype="application/json")

Deploy
No Azure Portal, crie um Function App (plano Consumption, Runtime Python 3.9+).


Habilite a Managed Identity do Function App e, no Key Vault, d√™ permiss√£o de leitura (‚ÄúGet‚Äù) para ela.


Defina em Application Settings:


KEYVAULT_NAME = nome do seu Key Vault (ex.: eluminai-kv).


ADVBOX_API_BASE (se for vari√°vel; caso contr√°rio, deixar hardcoded).


Publique o c√≥digo pelo VS Code (Azure Functions Extension) ou via CI/CD.



3.3. Azure Function ‚ÄúProcessaEmail‚Äù
# Arquivo: processa_email_function.py
import os
import json
import logging
import azure.functions as func
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient
from azure.ai.openai import OpenAIClient, AzureKeyCredential
# Se quiser baixar anexos e converter em base64, importe azure.storage.blob, base64, etc.

# Settings (definidos em Application Settings do Function App)
KEYVAULT_NAME = os.getenv("KEYVAULT_NAME")            # ex.: "eluminai-kv"
KV_URI = f"https://{KEYVAULT_NAME}.vault.azure.net"
OPENAI_ENDPOINT = os.getenv("OPENAI_ENDPOINT")        # ex.: "https://eluminai-openai.openai.azure.com/"
OPENAI_DEPLOYMENT = os.getenv("OPENAI_DEPLOYMENT")    # ex.: "gpt-35-turbo"
# (Opcional) STORAGE_ACCOUNT_NAME, STORAGE_ACCOUNT_CONTAINER se for usar Blob SAS

def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info("ProcessaEmail: recebendo requisi√ß√£o")

    try:
        body = req.get_json()
    except:
        return func.HttpResponse("JSON inv√°lido.", status_code=400)

    remetente = body.get("from", "")
    assunto = body.get("subject", "")
    texto_email = body.get("body", "")
    anexos = body.get("attachments", [])  # cada item: { "filename": "...", "blobUrl": "..." }

    # 1) Montar prompt para o LLM
    prompt = montar_prompt(remetente, assunto, texto_email, anexos)

    # 2) Autenticar no Key Vault para obter OPENAI_API_KEY
    credential = DefaultAzureCredential()
    secret_client = SecretClient(vault_url=KV_URI, credential=credential)
    openai_key = secret_client.get_secret("OPENAI_API_KEY").value

    # 3) Chamar Azure OpenAI
    logging.info("Chamando Azure OpenAI para extrair e classificar dados...")
    client = OpenAIClient(OPENAI_ENDPOINT, AzureKeyCredential(openai_key))
    response = client.get_chat_completions(
        deployment_id=OPENAI_DEPLOYMENT,
        messages=[
            {"role": "system", "content": "Voc√™ √© um assistente que extrai dados contratuais de e-mails e gera um resumo em portugu√™s."},
            {"role": "user", "content": prompt}
        ],
        max_tokens=600,
        temperature=0.0
    )

    conteudo = response.choices[0].message.content
    logging.info(f"Resposta LLM: {conteudo}")

    # 4) Tentar parsear JSON
    try:
        resultado = json.loads(conteudo)
    except json.JSONDecodeError as e:
        logging.error(f"Falha ao decodificar JSON do LLM: {e}")
        return func.HttpResponse(status_code=500, body="Resposta do LLM n√£o retornou JSON v√°lido.")

    # 5) Construir lista de anexos para RPA (mantendo apenas filename e blobUrl)
    anexos_para_rpa = []
    for a in anexos:
        filename = a.get("filename")
        blobUrl = a.get("blobUrl")
        anexos_para_rpa.append({ "filename": filename, "blobUrl": blobUrl })

    # 6) Montar JSON de resposta
    saida = {
        "cliente": resultado.get("cliente"),
        "tipoSolicitacao": resultado.get("tipoSolicitacao"),
        "dadosExtraidos": {
            "numeroContrato": resultado.get("numeroContrato"),
            "valor": resultado.get("valor"),
            "prazo": resultado.get("prazo"),
            "advogadoResponsavel": resultado.get("advogadoResponsavel")
        },
        "summary": resultado.get("summary"),
        "anexosParaRPA": anexos_para_rpa
    }

    return func.HttpResponse(
        status_code=200,
        body=json.dumps(saida, ensure_ascii=False),
        mimetype="application/json"
    )

def montar_prompt(remetente: str, assunto: str, texto_email: str, anexos: list) -> str:
    """
    Monta o prompt que enviaremos ao LLM. Solicitamos:
     1) Classificar o tipo de solicita√ß√£o.
     2) Extrair cliente, numeroContrato, valor, prazo, advogadoResponsavel.
     3) Gerar resumo em at√© 2‚Äì3 frases.
     4) Retornar apenas JSON v√°lido conforme schema.
    """
    lista_anexos = ", ".join([a.get("filename") for a in anexos]) if anexos else "nenhum"
    texto = f"""
    Voc√™ √© um assistente que recebe estes dados de um e-mail:
    - Remetente: {remetente}
    - Assunto: {assunto}
    - Corpo do e-mail: \"\"\"{texto_email}\"\"\"
    - Anexos: {lista_anexos}

    Por favor:
    1) Classifique a solicita√ß√£o em um destes valores (campo "tipoSolicitacao"):
       - "novo_contrato"
       - "renovacao_contrato"
       - "alteracao_contrato"
       - "rescisao_contrato"
       - "outro"

    2) Extraia estes campos obrigat√≥rios (campos no JSON):
       - "cliente": nome exato da empresa ou pessoa
       - "numeroContrato": se mencionado (s√≥ n√∫meros)
       - "valor": se mencionado (apenas n√∫meros e separadores)
       - "prazo": se mencionado (ex.: "12 meses", "30 dias")
       - "advogadoResponsavel": e-mail ou nome do advogado, se houver

    3) Gere um resumo (campo "summary") em portugu√™s, no m√°ximo 2 ou 3 frases.

    4) Retorne **apenas** um objeto JSON com esta estrutura:
    {{
      "cliente": "...",
      "numeroContrato": "...",
      "valor": "...",
      "prazo": "...",
      "tipoSolicitacao": "...",
      "advogadoResponsavel": "...",
      "summary": "..."
    }}
    """
    return texto.strip()

Deploy
No portal Azure, crie (ou reutilize) o mesmo Function App do ‚ÄúValidaCliente‚Äù.


Defina as Application Settings:


KEYVAULT_NAME ‚Üí nome do seu Key Vault (ex.: eluminai-kv).


OPENAI_ENDPOINT ‚Üí endpoint do seu Azure OpenAI (ex.: https://eluminai-openai.openai.azure.com/).


OPENAI_DEPLOYMENT ‚Üí nome do deployment (ex.: gpt-35-turbo).


Habilite a Managed Identity do Function App (se ainda n√£o fez).


No Key Vault, cuide de conceder permiss√£o ‚ÄúGet‚Äù para essa identidade acessar OPENAI_API_KEY.


Publique o c√≥digo (VS Code + Azure Functions Extension ou CI/CD).


Teste usando ‚ÄúTest in portal‚Äù ou Postman, enviando JSON de exemplo:

 {
  "from": "cliente@exemplo.com.br",
  "subject": "Renova√ß√£o de contrato",
  "body": "Ol√°, gostaria de renovar o contrato n√∫mero 7890 no valor de R$ 25.000,00 por 6 meses. Advogado: ricardo@advocacia.com. Anexo proposta.pdf.",
  "attachments": [
    {
      "filename": "proposta.pdf",
      "blobUrl": "https://<conta>.blob.core.windows.net/tempanexos/proposta.pdf?<SASToken>"
    }
  ]
}


Aguarde retorno algo tipo:

 {
  "cliente": "Empresa Exemplo",
  "tipoSolicitacao": "renovacao_contrato",
  "dadosExtraidos": {
    "numeroContrato": "7890",
    "valor": "25000",
    "prazo": "6 meses",
    "advogadoResponsavel": "ricardo@advocacia.com"
  },
  "summary": "Empresa Exemplo solicita renova√ß√£o do contrato 7890 no valor de R$ 25.000,00 por 6 meses. Anexo: proposta.pdf.",
  "anexosParaRPA": [
    { "filename": "proposta.pdf", "blobUrl": "https://<conta>.blob.core.windows.net/tempanexos/proposta.pdf?<SASToken>" }
  ]
}



3.4. Power Automate Cloud ‚Äì Fluxo Completo
1) Gatilho
Conector: Office 365 Outlook ‚Üí ‚ÄúQuando um novo e-mail chega (V3)‚Äù.


Configura√ß√µes:


Caixa: caixa compartilhada (ex.: suporte@seudominio.com).


Pasta: /Inbox/SolicitacoesContratuais.


Aplica filtro de anexos (opcional) ou de assunto.


2) (Opcional) Verificar dom√≠nio do remetente
Insira uma a√ß√£o ‚ÄúCondi√ß√£o‚Äù com express√£o:

 @contains(triggerOutputs()?['body/from'], '@cliente.com.br')


Se Falso:


Enviar e-mail (Office 365 Outlook ‚Äì ‚ÄúEnviar um e-mail (V2)‚Äù) para o remetente:


Assunto: ‚ÄúRemetente n√£o autorizado‚Äù


Corpo: ‚ÄúDesculpe, seu e-mail n√£o pertence √† uma conta de cliente cadastrada.‚Äù


Terminar fluxo.


Se Verdadeiro: continuar.


3) Chamar Azure Function ValidaCliente (HTTP)
A√ß√£o: HTTP


M√©todo: POST


URL:

 https://<seu-func-app>.azurewebsites.net/api/ValidaCliente?code=<sua-chave-de-func>


Cabe√ßalhos: { "Content-Type": "application/json" }


Corpo:

 { "cliente": "@{triggerOutputs()?['body/from']}" }


Armazene a resposta em uma vari√°vel chamada statusClienteResponse.


4) Condi√ß√£o de statusCliente
Avalie:

 @equals(body('ValidaCliente')?['status'], 'inativo')


Se ‚Äúinativo‚Äù:


Enviar e-mail para o remetente:


Assunto: ‚ÄúCliente inativo‚Äù


Corpo: ‚ÄúSeu cadastro est√° inativo. Entre em contato com o suporte.‚Äù


Terminar fluxo.


Outro ramo:

 @equals(body('ValidaCliente')?['status'], 'nao_encontrado')


Se ‚Äúnao_encontrado‚Äù:


Enviar e-mail ‚ÄúCliente n√£o cadastrado.‚Äù


Terminar fluxo.


Caso contr√°rio (status == "ativo"), prossiga.


5) (Opcional) Obter e salvar Anexos
Se desejar que a Function receba apenas URLs em vez de base64 grande, fa√ßa:
Condi√ß√£o:

 @greater(length(triggerOutputs()?['body/HasAttachments']), 0)


Se houver anexos:


‚ÄúObter anexos‚Äù (Get attachments) ‚Üí retorna lista com metadados (Attachments).


Para cada anexo em Attachments:


‚ÄúObter conte√∫do do anexo‚Äù ‚Üí retorna contentBytes base64.


‚ÄúCriar blob‚Äù (Azure Blob Storage)


Conta: sua Storage Account.


Container: tempanexos.


Blob name: @{items('Aplicar_para_cada')?['Name']}


Blob content: @{body('Get_attachment')?['contentBytes']}


Gere URL SAS para esse blob (no pr√≥prio conector, escolha ‚ÄúConceder acesso (SAS)‚Äù por 2 horas).


Monte um registro JSON:

 {
  "filename": "@{items('Aplicar_para_cada')?['Name']}",
  "blobUrl": "@{body('Criar_blob')?['BlobUriWithSas']}"
}


Armazene esse registro em uma vari√°vel de array anexosParaEnvio.


Se n√£o houver anexos: defina anexosParaEnvio como [].


6) Chamar Azure Function ProcessaEmail
A√ß√£o: HTTP


M√©todo: POST


URL:

 https://<seu-func-app>.azurewebsites.net/api/ProcessaEmail?code=<sua-chave-de-func>


Cabe√ßalhos: { "Content-Type": "application/json" }


Corpo:

 {
  "from": "@{triggerOutputs()?['body/from']}",
  "subject": "@{triggerOutputs()?['body/subject']}",
  "body": "@{triggerOutputs()?['body/bodyPreview']}",
  "attachments": @{variables('anexosParaEnvio')}
}


Armazene a resposta JSON em ResultadoEmail.


7) Validar sa√≠da de ProcessaEmail
Condi√ß√£o (para checar se ResultadoEmail.cliente existe):

 @equals(body('ProcessaEmail')?['cliente'], null)


Se verdadeiro:


Enviar e-mail para TI: ‚ÄúFalha ao processar e-mail. JSON do LLM inv√°lido.‚Äù


Terminar.


Se falso: continuar.


8) Executar RPA (Power Automate Desktop)
A√ß√£o: ‚ÄúRun a flow built with Power Automate Desktop‚Äù


Selecione: ambiente e fluxo RPA_CriarTarefa_ADVBox.


Par√¢metros de entrada:


Nome (PAD)
Valor
cliente
@{body('ProcessaEmail')?['cliente']}
tipoSolicitacao
@{body('ProcessaEmail')?['tipoSolicitacao']}
numeroContrato
@{body('ProcessaEmail')?['dadosExtraidos/numeroContrato']}
valor
@{body('ProcessaEmail')?['dadosExtraidos/valor']}
prazo
@{body('ProcessaEmail')?['dadosExtraidos/prazo']}
advogadoResponsavel
@{body('ProcessaEmail')?['dadosExtraidos/advogadoResponsavel']}
summary
@{body('ProcessaEmail')?['summary']}
anexosParaRPA
@{body('ProcessaEmail')?['anexosParaRPA']}


Armazenar sa√≠da em vari√°vel saidaRPA (que receber√° { "idAdvBox": "1234" }).


9) Enviar e-mail de confirma√ß√£o
A√ß√£o: Office 365 Outlook ‚Üí ‚ÄúEnviar um e-mail (V2)‚Äù


Para: @{triggerOutputs()?['body/from']}


CC: @{body('ProcessaEmail')?['dadosExtraidos/advogadoResponsavel']}


Assunto:

 Confirma√ß√£o de Tarefa ADVBox ‚Äì #@{body('saidaRPA')?['idAdvBox']}


Corpo (texto simples ou HTML):

 Ol√° @{body('ProcessaEmail')?['cliente']},

Sua solicita√ß√£o foi processada com sucesso!

‚Üí N√∫mero da Tarefa ADVBox: @{body('saidaRPA')?['idAdvBox']}
‚Üí Resumo: @{body('ProcessaEmail')?['summary']}

Advogado respons√°vel ( @{body('ProcessaEmail')?['dadosExtraidos/advogadoResponsavel']} ) j√° foi copiado.

Atenciosamente,
Equipe de Automa√ß√£o


10) Fim
O fluxo encerra com sucesso.



4. Power Automate Desktop (RPA) ‚Äì Passo a Passo
4.1. Criar o Flow no PAD
Abra o Power Automate Desktop e crie um novo fluxo chamado RPA_CriarTarefa_ADVBox.


Configurar Vari√°veis de Entrada:


Na guia ‚ÄúVari√°veis‚Äù, clique em ‚ÄúAdicionar vari√°vel‚Äù e selecione ‚ÄúEntrada de fluxo‚Äù para cada um:


cliente (Tipo: Texto)


tipoSolicitacao (Texto)


numeroContrato (Texto)


valor (Texto)


prazo (Texto)


advogadoResponsavel (Texto)


summary (Texto)


anexosParaRPA (Tipo: Lista de Registros)


Armazenar Credenciais ADVBox:


No PAD, v√° em ‚ÄúGerenciar Credenciais‚Äù e crie uma credencial chamada Credencial_ADVBox com usu√°rio (ADVBOX_USER) e senha (ADVBOX_PASS).


4.2. Sequ√™ncia de A√ß√µes
Abrir Navegador


A√ß√£o: ‚ÄúLaunch new Chrome‚Äù (ou ‚ÄúMicrosoft Edge‚Äù)


URL: https://app.advbox.com/login


Aguarde 5 segundos para carregar.


Fazer Login


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù


Seletor: campo ‚ÄúE-mail‚Äù do ADVBox (use inspecionar elemento para obter CSS/XPath).


Texto: %Credencial_ADVBox.Username%


A√ß√£o: ‚ÄúFill Secure Text Field on Web Page‚Äù


Seletor: campo ‚ÄúSenha‚Äù


Texto: %Credencial_ADVBox.Password%


A√ß√£o: ‚ÄúClick Element on Web Page‚Äù


Seletor: bot√£o ‚ÄúEntrar‚Äù


A√ß√£o: ‚ÄúWait‚Äù ‚Üí 5 segundos (ou ‚ÄúWait for Web Page Content‚Äù at√© que o menu principal apare√ßa).


Navegar at√© ‚ÄúNova Tarefa‚Äù


A√ß√£o: ‚ÄúClick Element on Web Page‚Äù


Seletor: √≠cone/menu lateral para ‚ÄúTarefas‚Äù.


A√ß√£o: ‚ÄúClick Element on Web Page‚Äù


Seletor: bot√£o ‚ÄúNova Tarefa‚Äù.


A√ß√£o: ‚ÄúWait‚Äù ‚Üí 5 segundos (at√© o formul√°rio carregar).


Preencher Campos do Formul√°rio


T√≠tulo:


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù


Seletor: campo ‚ÄúT√≠tulo‚Äù


Texto: Solicita√ß√£o %{tipoSolicitacao}% - %{cliente}%


Descri√ß√£o:


A√ß√£o: ‚ÄúFill Text Area on Web Page‚Äù


Seletor: campo ‚ÄúDescri√ß√£o‚Äù (√°rea de texto rica)


Texto: %summary%


Cliente (lista dropdown ou campo):


A√ß√£o: ‚ÄúSelect Item in List‚Äù ou ‚ÄúFill Text Field‚Äù


Seletor: dropdown/elemento ‚ÄúCliente‚Äù


Texto: %cliente%


N√∫mero do Contrato:


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù


Seletor: campo ‚ÄúN√∫mero do Contrato‚Äù


Texto: %numeroContrato%


Valor:


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù


Seletor: campo ‚ÄúValor‚Äù


Texto: %valor%


Prazo:


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù


Seletor: campo ‚ÄúPrazo‚Äù


Texto: %prazo%


Advogado Respons√°vel:


A√ß√£o: ‚ÄúFill Text Field on Web Page‚Äù (ou ‚ÄúSelect Item in List‚Äù)


Seletor: campo ‚ÄúAdvogado‚Äù


Texto: %advogadoResponsavel%


Anexar Documentos (se houver)


A√ß√£o: ‚ÄúIf‚Äù


Condi√ß√£o: Length(anexosParaRPA) > 0


Then (para cada anexo em anexosParaRPA):


A√ß√£o: ‚ÄúLaunch new Chrome‚Äù (ou reusar aba atual, dependendo da estrat√©gia)


URL: %CurrentItem.blobUrl%


Aguarde at√© que o navegador fa√ßa download autom√°tico (10 s).


A√ß√£o: ‚ÄúWait for file‚Äù


Caminho: %USERPROFILE%\Downloads\%CurrentItem.filename%


Timeout: 30 s


A√ß√£o: ‚ÄúClick Element on Web Page‚Äù


Seletor: bot√£o ‚ÄúAnexar arquivo‚Äù (no formul√°rio ADVBox).


A√ß√£o: ‚ÄúPopulate Text Field on Web Page‚Äù


Seletor: <input type="file">


Texto: %USERPROFILE%\Downloads\%CurrentItem.filename%


A√ß√£o: ‚ÄúWait‚Äù ‚Üí 5 s (para concluir upload).


A√ß√£o: ‚ÄúDelete File‚Äù


Caminho: %USERPROFILE%\Downloads\%CurrentItem.filename% (opcional, para n√£o poluir a pasta).


EndIf.


Salvar Tarefa


A√ß√£o: ‚ÄúClick Element on Web Page‚Äù


Seletor: bot√£o ‚ÄúSalvar‚Äù (ou ‚ÄúCriar‚Äù).


A√ß√£o: ‚ÄúWait‚Äù ‚Üí 5‚Äì10 segundos at√© aparecer mensagem de confirma√ß√£o.


A√ß√£o: ‚ÄúGet Details of Element on Web Page‚Äù


Seletor: elemento de texto que cont√©m ‚ÄúTarefa #1234 criada com sucesso.‚Äù


Salve em %textoConfirmacao%.


A√ß√£o: ‚ÄúExtract Text from Text‚Äù


Modo: Regex


Express√£o regular: #(\d+)


Texto de entrada: %textoConfirmacao%


Salvar em %idAdvBox%.


Fechar Navegador


A√ß√£o: ‚ÄúClose Window‚Äù (ou ‚ÄúTerminate Process‚Äù ‚Üí chrome.exe).


Retornar Resultado


A√ß√£o: ‚ÄúReturn Value(s) to calling flow‚Äù


Par√¢metro de sa√≠da:

 { "idAdvBox": "%idAdvBox%" }


Extrair Logs/Tratamento de Erros (opcional)


Envolva etapas cr√≠ticas em ‚ÄúTry / Catch‚Äù no PAD:


Se falha ao clicar ou importar elemento, capture screenshot (%CurrentTimestamp%.png) e envie e-mail local (caso Outlook esteja configurado) para TI.


Se falha ao baixar anexo, registre em arquivo de log local (ErroAnexo_%CurrentTimestamp%.txt) com detalhes e continue sem anexos.


Publicar


Clique em Publicar no PAD. Nomeie o fluxo como RPA_CriarTarefa_ADVBox.



5. Pormenores de Configura√ß√£o do LLM (Azure OpenAI)
Criar Recurso Azure OpenAI


No portal, ‚ÄúCriar recurso‚Äù ‚Üí ‚ÄúAzure OpenAI‚Äù.


Nome: eluminai-openai.


Regionaliza√ß√£o conforme necessidade.


Provisione com modelo GPT-3.5-turbo (ou GPT-4 se dispon√≠vel).


Deployment


Ap√≥s criado, v√° em Deployments e crie um deployment para gpt-35-turbo (alias do modelo).


Anote o endpoint e crie uma chave (Key1)


Copie o endpoint (ex.: https://eluminai-openai.openai.azure.com/) e a sua chave para o Key Vault (como OPENAI_API_KEY).


Configura√ß√µes Sugeridas do Modelo


Temperature: 0.0 (respostas determin√≠sticas).


Max Tokens: 600.


System Prompt (de exemplo, dentro da Function):

 Voc√™ √© um assistente que extrai dados contratuais de e-mails e gera um resumo em portugu√™s.


User Prompt: conforme m√©todo montar_prompt().


Testes de Prompt


Use o ‚ÄúTest in Portal‚Äù do Azure OpenAI para validar que, dados e-mails de exemplo, o modelo retorna exatamente um JSON v√°lido com as chaves exigidas.


Caso quebre a formata√ß√£o, torne o ‚ÄúUser Prompt‚Äù mais restritivo, pedindo ‚Äúretorne apenas JSON, sem texto adicional‚Äù.



6. Configura√ß√£o de Storage Account (Anexos)
Criar Storage Account


Nome: eluminaiattachments.


Plano Standard LRS.


Crie um container p√∫blico/privado chamado tempanexos.


Gerar SAS Programaticamente (opcional)


Se preferir que a Azure Function gere a URL SAS, instale no ambiente da Function:

 pip install azure-storage-blob


Dentro da Function, use algo como:

 from azure.storage.blob import generate_blob_sas, BlobSasPermissions
import datetime

def gerar_sas_url(blob_name: str) -> str:
    from azure.storage.blob import BlobServiceClient
    connection_str = secret_client.get_secret("BLOB_CONNECTION_STRING").value
    blob_service = BlobServiceClient.from_connection_string(connection_str)
    sas_token = generate_blob_sas(
        account_name=blob_service.account_name,
        container_name=STORAGE_ACCOUNT_CONTAINER,
        blob_name=blob_name,
        account_key=blob_service.credential.account_key,
        permission=BlobSasPermissions(read=True),
        expiry=datetime.datetime.utcnow() + datetime.timedelta(hours=2)
    )
    url = f"https://{blob_service.account_name}.blob.core.windows.net/{STORAGE_ACCOUNT_CONTAINER}/{blob_name}?{sas_token}"
    return url


Assim, em vez de subir os anexos pelo Power Automate, voc√™ pode aceitar base64 e converter em blobs dentro da Function. Mas, para simplificar, normalmente o Power Automate Cloud j√° faz upload direto ao Blob e gera SAS.


Gerenciar Ciclo de Vida


No container tempanexos, crie regra de Expira√ß√£o para apagar blobs com mais de 2 horas, evitando acumular arquivos.



7. Monitoramento e Tratamento de Erros
Azure Functions


Ative Application Insights (dentro do Function App ‚Üí ‚ÄúPlatform Features‚Äù ‚Üí ‚ÄúApplication Insights‚Äù) para capturar logs e m√©tricas.


Use logging.info(), logging.error() no c√≥digo para registrar pontos cr√≠ticos (recebimento de payload, chamada ao OpenAI, parsing do JSON, erros).


Configure alertas no Azure para notificar o time de TI se o n√∫mero de falhas ultrapassar um limiar (ex.: 5 falhas/dia).


Power Automate Cloud


Cada execu√ß√£o gera um Run History. Acesse para ver erros em cada a√ß√£o.


Configure alertas de falha (dentro do ambiente Power Automate, v√° em ‚ÄúAlerts‚Äù e crie notifica√ß√£o por e-mail ou Teams se o fluxo falhar).


Power Automate Desktop


Habilite logs detalhados (no PAD ‚Üí ‚ÄúSettings‚Äù ‚Üí ‚ÄúDiagnostics‚Äù ‚Üí marque ‚ÄúEnable Logging‚Äù).


Caso o RPA encontre um erro cr√≠tico (por exemplo, n√£o encontra o bot√£o ‚ÄúSalvar‚Äù no ADVBox), capture screenshot e envie e-mail local (caso Outlook esteja configurado no Windows) para a equipe de TI.


Ciclo de Vida de Blobs


Regra de expira√ß√£o autom√°tica (2 horas) para o container tempanexos.



8. Custo Aproximado (R1/Base)
Azure OpenAI:


GPT-3.5-turbo: ~US$ 0,002 por 1k tokens.


30 execu√ß√µes/dia √ó 600 tokens = 18.000 tokens/dia ‚Üí US$ 0,036/dia ‚Üí US$ ~1/m√™s.


Azure Functions (Consumption):


900 execu√ß√µes/m√™s (30 √ó 30 dias) ‚Üí dentro do n√≠vel gratuito (1 milh√£o execu√ß√µes gr√°tis).


Storage Account:


Armazenar blobs tempor√°rios, 10 MB √ó 30/dia √ó 2 horas ‚Üí custo desprez√≠vel (<US$ 1/m√™s).


Power Automate Cloud:


Licen√ßa ‚Äúper user‚Äù ou ‚Äúper flow‚Äù (dependendo do contrato corporativo): normalmente R$ 80‚Äì150/m√™s.


Power Automate Desktop (RPA):


Licen√ßa RPA no Windows: R$ 200/ano (‚âàR$ 17/m√™s).


Browser-Use (RPA em nuvem):


Estimado R$ 1‚Äì2 por tarefa.


30 tarefas/dia ‚Üí R$ 30‚Äì60/dia ‚Üí R$ 900‚Äì1.800/m√™s.


Se preferir Power Automate Desktop local (sem servi√ßo ‚ÄúBrowser-Use‚Äù em nuvem), n√£o haver√° esse custo por tarefa, mas exige manter a VM Windows sempre dispon√≠vel (custo de m√°quina + manuten√ß√£o).


Em cen√°rio h√≠brido (parte roda local, parte no Azure):
√â poss√≠vel reduzir o custo de ‚ÄúBrowser-Use‚Äù executando RPA puramente on-premises (ou seja, Power Automate Desktop em VM Windows, sem Microsoft Browser-Use). Nesse caso, o custo de RPA vira apenas a licen√ßa do PAD e o custo da pr√≥pria VM.



9. Check-List de Entrega
Azure


Resource Group criado.


Storage Account (eluminaiattachments) e container tempanexos.


Key Vault (eluminai-kv) com segredos: OPENAI_API_KEY, ADVBOX_USER, ADVBOX_PASS, ADVBOX_API_TOKEN, BLOB_CONNECTION_STRING.


Azure Function App configurado (Managed Identity habilitada).


Fun√ß√£o ValidaCliente publicada e testada.


Fun√ß√£o ProcessaEmail publicada e testada.


Azure OpenAI criado e deployment configurado (gpt-35-turbo).


Power Automate Cloud


Criado fluxo ‚ÄúFluxo_CriarTarefa_ADVBox‚Äù com todas as etapas (gatilho, condi√ß√µes, chamadas HTTP, RPA, e-mail).


Conector Outlook 365 configurado para ler caixa compartilhada.


Conector HTTP validado (chama fun√ß√µes e recebe JSON).


Conector ‚ÄúRun a flow built with Power Automate Desktop‚Äù validado.


Power Automate Desktop


Criado fluxo RPA_CriarTarefa_ADVBox com as vari√°veis de entrada.


Inseridos passos de login no ADVBox e cria√ß√£o da tarefa.


Validado que, ap√≥s ‚ÄúSalvar‚Äù, o n√∫mero da tarefa √© extra√≠do corretamente (idAdvBox).


Fluxo publicado e dispon√≠vel para execu√ß√£o pelo Cloud.


Teste Ponta a Ponta


Enviar ao menos 3 e-mails de teste cobrindo:


Cliente ativo, sem anexos.


Cliente ativo, com anexos.


Cliente inativo ou inexistente.


Verificar no Logs do Power Automate Cloud e Azure Functions se n√£o h√° erros.


Verificar no ADVBox se as tarefas foram criadas (caso cliente ativo).


Verificar se e-mail de confirma√ß√£o chegou ao cliente e advogados (com id da tarefa e resumo).


Monitoramento e Alertas


Application Insights configurado no Function App (alerta de falhas).


Power Automate Cloud Alerts configurados para notificar time de TI em caso de falha.


Ciclo de vida de blobs em tempanexos configurado (2 horas).



10. Conclus√£o
Com esta solu√ß√£o:
Todos os e-mails de solicita√ß√µes contratuais que chegarem a suporte@seudominio.com ser√£o analisados automaticamente.


Clientes n√£o autorizados (inativos/inexistentes) receber√£o resposta imediata de ‚Äúcliente n√£o cadastrado‚Äù ou ‚Äúinativo‚Äù.


E-mails v√°lidos ser√£o enviados ao LLM (Azure OpenAI) para extra√ß√£o de dados e resumo.


A tarefa ser√° criada no ADVBox via RPA (Power Automate Desktop), mesmo sem API POST, justamente simulando a navega√ß√£o.


O cliente e o advogado respons√°vel receber√£o um e-mail de confirma√ß√£o com n√∫mero do ticket ADVBox e resumo da solicita√ß√£o.


Essa arquitetura utiliza Power Automate Cloud como orquestrador, Azure Functions + Azure OpenAI para intelig√™ncia (classifica√ß√£o/extra√ß√£o/resumo) e Power Automate Desktop (RPA) para realizar a a√ß√£o criadora de tarefas no ADVBox pela interface web. Cada camada √© escal√°vel e monitorada, e voc√™ tem um custo de opera√ß√£o bastante enxuto, especialmente se usar o RPA on-premises no lugar do servi√ßo pago ‚ÄúBrowser-Use‚Äù.
Se precisar de algum ajuste mais fino em seletores do ADVBox, modelos de prompt do LLM ou configura√ß√µes de Power Automate, estou √† disposi√ß√£o para ajudar.

‚úÖ Complementar o Projeto com o Fluxo ‚ÄúAstrea ‚Üí E-mail ‚Üí ADVBox‚Äù
üéØ Objetivo dessa etapa
Automatizar a leitura dos e-mails enviados automaticamente pelo sistema Astrea (push de andamentos processuais) e inserir essas informa√ß√µes no ADVBox, de forma similar √† cria√ß√£o de tarefas ‚Äî por√©m com foco em atualiza√ß√£o de processo.

üß† L√≥gica do Fluxo Adicional
üì• Origem:
Sistema Astrea envia e-mails com informa√ß√µes de andamento processual (ex: juntada de procura√ß√£o).
üßæ Conte√∫do:
E-mail possui resumo do evento (juntada, despacho, audi√™ncia)
Vinculado a um n√∫mero de processo
üß† Automa√ß√£o:
A IA (Azure OpenAI ou LLM local) interpreta o conte√∫do
Extrai: n√∫mero do processo, tipo de evento, data, texto principal
Power Automate verifica se o processo existe no ADVBox
Atualiza o processo no ADVBox com o novo andamento (via RPA local)

‚è±Ô∏è Horas adicionais estimadas para implementar esse fluxo extra
Etapa
Horas Estimadas
üì© Ajustar captura de e-mails do Astrea (filtro espec√≠fico)
1h
üß† Treinar e validar prompt do LLM para extra√ß√£o de dados processuais
2h
üîÅ Adicionar l√≥gica de verifica√ß√£o do processo no ADVBox (via RPA)
2h
üì§ Automatizar atualiza√ß√£o de processo no ADVBox via PAD
3h
üß™ Testes com diferentes tipos de andamentos / varia√ß√µes de formato
2h
üìÑ Logging, confirma√ß√£o e fallback (ex: processo n√£o encontrado)
1h
Total adicional estimado
11h



